{
  "active": false,
  "connections": {},
  "createdAt": "2025-04-15T16:22:56.070Z",
  "id": "uhMkhlsEAXUbgTBW",
  "isArchived": false,
  "meta": null,
  "name": "My workflow 43",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DECLARE @MRN VARCHAR(10)= '886920'\nDECLARE @STARTDATE DATE='2025-04-15'\nDECLARE @ENDDATE DATE = DATEADD(DAY, 1, CAST(GETDATE() AS DATE));\n\nWITH proc_cpt_ordered AS (\n    SELECT e.IMREDEMEC_CODE,e.enc_chartpulltime,d.DEM_EXTERNALID,d.DEM_FIRSTNAME,d.DEM_LASTNAME,d.DEM_DATEOFBIRTH\n\t\t,CASE \n        --WHEN PROC_CODE = '45380' THEN 275 -- Colonoscopy (With Biopsy)\n        WHEN PROC_CODE = '77067' THEN 45  -- Mammogram Breast Bilateral Screening Digital\n        WHEN PROC_CODE = '93306' THEN 80  -- 2D Echocardiogram\n\t\tWHEN PROC_CODE = '93307' THEN 80  -- 2D Echocardiogram\n        WHEN PROC_CODE = '93015' THEN 251 -- Exercise Stress Test\n        WHEN PROC_CODE = '95800' THEN 61  -- Sleep Study Pick-up\n        WHEN PROC_CODE = '93228' THEN 261 -- Ambulatory Cardiovascular Telemetry\n        WHEN PROC_CODE = '93925' THEN 239  -- LE Arterial Duplex-Bilateral (Vascular)\n\t    WHEN PROC_CODE = '76700' THEN 240 -- US Abdomen Complete\n        WHEN PROC_CODE = '76830' THEN 258 -- US Transvaginal\n        WHEN PROC_CODE = '93880' THEN 245 -- Carotid Duplex\n        WHEN PROC_CODE = '93924' THEN 253 -- ABI- Rest and Exercise\n        WHEN PROC_CODE = '43235' THEN 276 -- EGD (Diagnostic)\n        WHEN PROC_CODE = '76641' THEN 219 -- US Breast Unilateral (Drop Twice for Bilateral)\n        WHEN PROC_CODE = '93971' THEN 248 -- Lower Extremity Venous Doppler (Unilateral)\n        WHEN PROC_CODE = '76642' THEN 219 -- US Breast Bilateral Limited\n        WHEN PROC_CODE = '76870' THEN 213 -- US Scrotum and Testicles\n        WHEN PROC_CODE = '93227' THEN 261 -- 24-48 HR Holter Monitor\n        WHEN PROC_CODE = '93976' THEN 241 -- US Doppler Renal Artery\n        WHEN PROC_CODE = '43239' THEN 276 -- EGD, with Biopsy\n        WHEN PROC_CODE = '93970' THEN 248 -- Venous Duplex Scan for Venous Insufficiency-Bilateral\n        WHEN PROC_CODE = '93976' THEN 241 -- Doppler Ultrasound of Renal Artery\n        WHEN PROC_CODE = '76856' THEN 257 -- US Pelvis (Without Transvaginal Probe)\n        WHEN PROC_CODE = '76536' THEN 175 -- US Thyroid (Neck/Head)\n        WHEN PROC_CODE = '76705' THEN 240 -- US Abdomen Right Upper Quadrant\n        WHEN PROC_CODE = '76775' THEN 241 -- US Abdominal Aorta\n        WHEN PROC_CODE = '76604' THEN 256 -- US Soft Tissue Chest\n        WHEN PROC_CODE = '77065' THEN 219 -- Diagnostic Mammogram Right Breast\n        WHEN PROC_CODE = '77066' THEN 45  -- Diagnostic Mammogram Bilateral\n        WHEN PROC_CODE = '77063' THEN 45  -- Screening Mammography with Tomosynthesis\n\t\tWHEN PROC_CODE = '77080' THEN 431 -- DEXA SCAN Whole Body (VAT,MMD,BMD)\n        WHEN PROC_CODE = '77080' THEN 431 -- DEXA SCAN Hip and Spine\n        WHEN PROC_CODE = '78351' THEN 431 -- Bone Densitometry\n        WHEN PROC_CODE = '93971' THEN 248 -- Venous Doppler Unilateral (Lower Extremity)\n        WHEN PROC_CODE = '93225' THEN 261 -- Holter Monitoring 48 Hours or Less\n        WHEN PROC_CODE = '93970' THEN 248 -- Venous Duplex Scan Lower Extremity\n        WHEN PROC_CODE = '95806' THEN 61  -- Home Sleep Study\n        WHEN PROC_CODE = '58558' THEN 154 -- Hysteroscopy with Biopsy\n        WHEN PROC_CODE = '93926' THEN 239 -- LE Arterial Duplex Unilateral\n        WHEN PROC_CODE = '93970' THEN 248 -- Venous Doppler Bilateral\n        WHEN PROC_CODE = '93976' THEN 241 -- Renal Doppler Ultrasound\n        WHEN PROC_CODE = '76882' THEN 256 -- US Popliteal Fossa Left\n        WHEN PROC_CODE = '76830' THEN 258 -- US Transvaginal\n        WHEN PROC_CODE = '76882' THEN 256 -- US Soft Tissue of Lower Extremity\n        WHEN PROC_CODE = '76705' THEN 240 -- US Abdomen Right Upper Quadrant\n        WHEN PROC_CODE = '76642' THEN 219 -- US Breast Limited\n        WHEN PROC_CODE = '58558' THEN 154 -- Hysteroscopy with Endometrial Sampling\n        WHEN PROC_CODE = '76882' THEN 256 -- Soft Tissue Ultrasound\n        WHEN PROC_CODE = '76870' THEN 213 -- US Scrotum and Testicles\n        WHEN PROC_CODE = '93970' THEN 248 -- Venous Duplex Bilateral\n        WHEN PROC_CODE = '76700' THEN 240 -- Abdominal Ultrasound\n        WHEN PROC_CODE = '77067' THEN 45  -- Screening Mammogram\n        WHEN PROC_CODE = '76856' THEN 257 -- US Pelvis Complete\n        WHEN PROC_CODE = '76770' THEN 222 -- US Kidney and Bladder\n        WHEN PROC_CODE = '77065' THEN 219 -- Diagnostic Mammogram Right Breast\n        WHEN PROC_CODE = '76506' THEN 175 -- Head Ultrasound\n        WHEN PROC_CODE = '76705' THEN 240 -- Abdominal Ultrasound\n        WHEN PROC_CODE = '58558' THEN 154 -- Hysteroscopy\n        WHEN PROC_CODE = '76882' THEN 256 -- Soft Tissue Ultrasound Extremity\n        WHEN PROC_CODE = '77065' THEN 219 -- Diagnostic Mammogram Left Breast\n        WHEN PROC_CODE = '76856' THEN 257 -- US Pelvis Without Transvaginal\n        WHEN PROC_CODE = '93970' THEN 248 -- LE Venous Doppler Bilateral\n        WHEN PROC_CODE = '93930' THEN 48  -- Arterial Doppler Upper Extremity Bilateral\n        WHEN PROC_CODE = '93923' THEN 253 -- Arterial Doppler Measurement of Segmental Pressure\n        WHEN PROC_CODE = '93976' THEN 241 -- Renal Artery Doppler\n        WHEN PROC_CODE = '76830' THEN 258 -- Transvaginal Ultrasound\n        WHEN PROC_CODE = '76536' THEN 175 -- Neck Ultrasound\n        WHEN PROC_CODE = '76870' THEN 213 -- US Scrotum\n        WHEN PROC_CODE = '76775' THEN 241 -- Abdominal Aorta US\n        WHEN PROC_CODE = '76882' THEN 256 -- Popliteal Ultrasound\n\t    WHEN PROC_CODE = '95004' THEN 429 -- Allergy Testing\n\t\t\n      END AS APPOINTMENT_TYPE_ID,\n\t  CASE \n--    WHEN PROC_CODE = '45380' THEN 'COLONOSCOPY (WITH BIOPSY)'\n    WHEN PROC_CODE = '77067' THEN 'MAMMOGRAM BREAST BILATERAL SCREENING DIGITAL'\n    WHEN PROC_CODE = '93306' THEN '2D ECHOCARDIOGRAM'\n    WHEN PROC_CODE = '93307' THEN '2D ECHOCARDIOGRAM'\n    WHEN PROC_CODE = '93015' THEN 'EXERCISE STRESS TEST'\n    WHEN PROC_CODE = '95800' THEN 'SLEEP STUDY PICK-UP'\n    WHEN PROC_CODE = '93228' THEN 'AMBULATORY CARDIOVASCULAR TELEMETRY'\n    WHEN PROC_CODE = '93925' THEN 'LE ARTERIAL DUPLEX-BILATERAL (VASCULAR)'\n    WHEN PROC_CODE = '77080' THEN 'DEXA BONE DENSITY STUDY'\n    WHEN PROC_CODE = '76700' THEN 'US ABDOMEN COMPLETE'\n    WHEN PROC_CODE = '76830' THEN 'US TRANSVAGINAL'\n    WHEN PROC_CODE = '93880' THEN 'CAROTID DUPLEX'\n    WHEN PROC_CODE = '93924' THEN 'ABI- REST AND EXERCISE'\n    WHEN PROC_CODE = '43235' THEN 'EGD (DIAGNOSTIC)'\n    WHEN PROC_CODE = '76641' THEN 'US BREAST UNILATERAL'\n    WHEN PROC_CODE = '93971' THEN 'LOWER EXTREMITY VENOUS DOPPLER (UNILATERAL)'\n    WHEN PROC_CODE = '76642' THEN 'US BREAST BILATERAL LIMITED'\n    WHEN PROC_CODE = '76870' THEN 'US SCROTUM AND TESTICLES'\n    WHEN PROC_CODE = '93227' THEN '24-48 HR HOLTER MONITOR'\n    WHEN PROC_CODE = '93976' THEN 'US DOPPLER RENAL ARTERY'\n    WHEN PROC_CODE = '43239' THEN 'EGD, WITH BIOPSY'\n    WHEN PROC_CODE = '93970' THEN 'VENOUS DUPLEX SCAN FOR VENOUS INSUFFICIENCY-BILATERAL'\n    WHEN PROC_CODE = '93930' THEN 'UE ARTERIAL DUPLEX-BILATERAL (VASCULAR)'\n    WHEN PROC_CODE = '93926' THEN 'LE ARTERIAL DOPPLER (UNILATERAL)'\n    WHEN PROC_CODE = '93923' THEN 'ARTERIAL DOPPLER ULTRASOUND OF BOTH LOWER EXTREMITIES'\n    WHEN PROC_CODE = '76856' THEN 'US PELVIS (WITHOUT TRANSVAGINAL PROBE)'\n    WHEN PROC_CODE = '76536' THEN 'US THYROID (NECK/HEAD)'\n    WHEN PROC_CODE = '76705' THEN 'US ABDOMEN RIGHT UPPER QUADRANT'\n    WHEN PROC_CODE = '76775' THEN 'US ABDOMINAL AORTA'\n    WHEN PROC_CODE = '76604' THEN 'US SOFT TISSUE CHEST'\n    WHEN PROC_CODE = '77065' THEN 'DIAGNOSTIC MAMMOGRAM RIGHT BREAST'\n    WHEN PROC_CODE = '77066' THEN 'DIAGNOSTIC MAMMOGRAM BILATERAL'\n    WHEN PROC_CODE = '77063' THEN 'SCREENING MAMMOGRAPHY WITH TOMOSYNTHESIS'\n    WHEN PROC_CODE = '93225' THEN 'HOLTER MONITORING 48 HOURS OR LESS'\n    WHEN PROC_CODE = '95806' THEN 'HOME SLEEP STUDY'\n    WHEN PROC_CODE = '58558' THEN 'HYSTEROSCOPY WITH BIOPSY'\n    WHEN PROC_CODE = '76882' THEN 'SOFT TISSUE ULTRASOUND'\n    WHEN PROC_CODE = '76770' THEN 'US KIDNEY AND BLADDER'\n    WHEN PROC_CODE = '76506' THEN 'HEAD ULTRASOUND'\n    WHEN PROC_CODE = '77080' THEN 'DEXA BONE DENSITY HIP AND SPINE'\n\tWHEN PROC_CODE = '78351' THEN 'BONE DENSITOMETRY'\n    WHEN PROC_CODE = '76882' THEN 'SOFT TISSUE ULTRASOUND EXTREMITY'\n    WHEN PROC_CODE = '76856' THEN 'US PELVIS WITHOUT TRANSVAGINAL'\n    WHEN PROC_CODE = '93976' THEN 'RENAL ARTERY DOPPLER'\n    WHEN PROC_CODE = '93923' THEN 'ARTERIAL DOPPLER MEASUREMENT OF SEGMENTAL PRESSURE'\n    WHEN PROC_CODE = '93926' THEN 'LOWER ARTERIAL DOPPLER'\n    WHEN PROC_CODE = '76775' THEN 'ABDOMINAL AORTA US'\n    WHEN PROC_CODE = '93930' THEN 'UE ARTERIAL DUPLEX BILATERAL'\n    WHEN PROC_CODE = '93970' THEN 'LE VENOUS DOPPLER BILATERAL'\n    WHEN PROC_CODE = '76830' THEN 'TRANSVAGINAL ULTRASOUND'\n    WHEN PROC_CODE = '76870' THEN 'US SCROTUM'\n    WHEN PROC_CODE = '93925' THEN 'ARTERIAL DUPLEX BILATERAL Lower Limbs'\n    WHEN PROC_CODE = '93930' THEN 'ARTERIAL DOPPLER UPPER EXTREMITY BILATERAL'\n    WHEN PROC_CODE = '93970' THEN 'VENOUS DUPLEX BILATERAL'\n    WHEN PROC_CODE = '93976' THEN 'RENAL DOPPLER ULTRASOUND'\n    WHEN PROC_CODE = '76830' THEN 'TRANSVAGINAL ULTRASOUND'\n    WHEN PROC_CODE = '93930' THEN 'UE ARTERIAL DUPLEX BILATERAL'\n    WHEN PROC_CODE = '93923' THEN 'ARTERIAL DOPPLER SEGMENTAL PRESSURE'\n    WHEN PROC_CODE = '93926' THEN 'LE ARTERIAL DUPLEX UNILATERAL'\n    WHEN PROC_CODE = '76882' THEN 'SOFT TISSUE ULTRASOUND'\n    WHEN PROC_CODE = '76705' THEN 'ABDOMINAL ULTRASOUND'\n    WHEN PROC_CODE = '76882' THEN 'POPLITEAL ULTRASOUND'\n\tWHEN PROC_CODE = '95004' THEN 'ALLERGY TESTING'\n\t\n    \n\tEND AS APPOINTMENT_TYPE_DESCRIPTION\n    FROM [HPSITE].[ENCOUNTER] e\n\tLEFT JOIN [HPSITE].[CONTACT] c ON e.IMREENC_CODE = c.IMREENC_CODE \n    LEFT JOIN [EMR].[HPSITE].[PROCEDURES] p ON p.IMRECONTACT_CODE = c.IMRECONTACT_CODE\n\tleft join [HPSITE].[DEMOGRAPHICS_VIEW] d on d.IMREDEM_CODE=e.IMREDEMEC_CODE\n\t\n\t\n    WHERE CAST(e.ENC_CHARTPULLTIME AS DATE) BETWEEN @STARTDATE and @ENDDATE \n\t and d.DEM_EXTERNALID =@MRN\n\t \n),\nins_rank as(\nselect i.IMREDEM_CODE,i.INS_RANK,\nic.carrier_name,\nROW_NUMBER() over(partition by i.IMREDEM_CODE order by i.ins_enrollmentdate desc) as rn\nfrom [HPSITE].[INSURANCES] i left join [HPSITE].[INSURANCECARRIERS] ic on i.IMRECARRIER_CODE=ic.IMRECARRIER_CODE \n--AND ic.CARRIER_NAME like @INS\n)\nSELECT DISTINCT\np.IMREDEMEC_CODE,\np.DEM_EXTERNALID,\np.DEM_FIRSTNAME,p.DEM_LASTNAME,p.APPOINTMENT_TYPE_ID,p.APPOINTMENT_TYPE_DESCRIPTION,i.CARRIER_NAME\nFROM proc_cpt_ordered p\nleft join ins_rank i on p.IMREDEMEC_CODE=i.IMREDEM_CODE\nwhere p.APPOINTMENT_TYPE_ID is not null\nand i.rn=1 and i.INS_RANK=0\n"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "b3768d5e-0842-48e0-8c97-2f482b903b70",
      "name": "EMR_DCARE_ORDERS_WITH_ORDERABLE_CPTS1",
      "alwaysOutputData": true,
      "credentials": {
        "microsoftSql": {
          "id": "qYagSGVTKE5tZdos",
          "name": "Microsoft SQL EHR"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-04-15T16:22:56.070Z",
  "versionId": "8c34641d-c659-46d8-8edf-16c5ccce80cc"
}